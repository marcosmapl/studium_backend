// ============================================
// CONFIGURAÇÃO DO PRISMA
// ============================================

generator client {
    provider = "prisma-client-js"
    // previewFeatures = ["driverAdapters"]
}

datasource db {
    provider = "mysql"
}

// ============================================
// ENUMS
// ============================================

enum UnidadeFederativa {
    AC
    AL
    AP
    AM
    BA
    CE
    DF
    ES
    GO
    MA
    MT
    MS
    MG
    PA
    PB
    PR
    PE
    PI
    RJ
    RN
    RS
    RO
    RR
    SC
    SP
    SE
    TO
}

enum CategoriaSessao {
    TEORIA
    REVISAO
    RESOLUCAO_QUESTOES
    LEITURA
    OUTROS
}

enum GeneroUsuario {
    FEMININO
    MASCULINO
    OUTRO
}

enum SituacaoUsuario {
    ATIVO
    BLOQUEADO
    INATIVO
    EXCLUIDO
}

enum SituacaoSessao {
    AGENDADA
    CANCELADA
    EM_ANDAMENTO
    PAUSADA
    CONCLUIDA
}

enum SituacaoRevisao {
    AGENDADA
    IGNORADA
    CANCELADA
    EM_ANDAMENTO
    PAUSADA
    CONCLUIDA
}

enum SituacaoPlano {
    NOVO
    EM_ANDAMENTO
    CONCLUIDO
    EXCLUIDO
}

// ============================================
// MODELS
// ============================================

model Cidade {
    id                Int               @id @default(autoincrement())
    descricao         String
    unidadeFederativa UnidadeFederativa

    usuarios Usuario[]

    @@unique([descricao, unidadeFederativa])
    @@index([unidadeFederativa], map: "cidade__unidade_federativa_idx")
    @@map("cidade")
}

model GrupoUsuario {
    id        Int       @id @default(autoincrement())
    descricao String    @unique
    usuarios  Usuario[]

    @@map("grupo_usuario")
}

model Usuario {
    id              Int             @id @default(autoincrement())
    nome            String
    sobrenome       String
    username        String          @unique
    password        String
    email           String          @unique
    generoUsuario   GeneroUsuario
    situacaoUsuario SituacaoUsuario
    dataNascimento  DateTime?       @map("data_nascimento")
    ultimoAcesso    DateTime        @default(now()) @map("ultimo_acesso")
    createdAt       DateTime        @default(now()) @map("created_at")
    updatedAt       DateTime        @updatedAt @map("updated_at")

    cidade   Cidade @relation(fields: [cidadeId], references: [id], onDelete: Restrict, onUpdate: Cascade)
    cidadeId Int    @map("cidade_id")

    grupoUsuario   GrupoUsuario @relation(fields: [grupoUsuarioId], references: [id], onDelete: Restrict, onUpdate: Cascade)
    grupoUsuarioId Int          @map("grupo_usuario_id")

    planosEstudo PlanoEstudo[]

    @@index([username])
    @@index([email])
    @@index([grupoUsuarioId], map: "usuario__grupo_id_fkey")
    @@index([cidadeId], map: "usuario__cidade_id_fkey")
    @@map("usuario")
}

model Disciplina {
    id            Int      @id @default(autoincrement())
    titulo        String // Título da disciplina
    cor           String   @default("#FFFFFF") // Cor associada à disciplina em formato hexadecimal
    concluido     Boolean  @default(false) // Indica se a disciplina foi concluída
    importancia   Decimal  @default(1) @db.Decimal(3, 1) // Peso da disciplina (0.0 a 5.0)
    conhecimento  Decimal  @default(0) @db.Decimal(3, 1) // Nível conhecimento atual (0.0 a 5.0)
    horasSemanais Decimal  @map("horas_semanais") @db.Decimal(4, 2) // Mínimo de horas semanais alocadas por semana
    selecionada   Boolean  @default(true) // Indica se a disciplina está selecionada para o planejamento atual
    createdAt     DateTime @default(now()) @map("created_at")
    updatedAt     DateTime @updatedAt @map("updated_at")

    planoId Int         @map("plano_id")
    plano   PlanoEstudo @relation(fields: [planoId], references: [id], onDelete: Cascade, onUpdate: Cascade)

    topicos       Topico[]
    sessoesEstudo SessaoEstudo[]
    revisoes      Revisao[]
    blocoEstudos  BlocoEstudo[]

    @@unique([titulo, planoId])
    @@index([titulo])
    @@index([planoId], map: "disciplina__plano_id_fkey")
    @@map("disciplina")
}

model Topico {
    id           Int      @id @default(autoincrement())
    titulo       String // Título do tópico
    ordem        Int // Ordem do tópico dentro da disciplina
    concluido    Boolean  @default(false) // Indica se o tópico foi concluído
    edital       Boolean  @default(true) // Indica se o tópico está no edital
    estabilidade Decimal  @default(1.0) @db.Decimal(2, 1) // Nível de estabilidade do conteúdo (0.0 a 5.0)
    dificuldade  Decimal  @default(5.0) @db.Decimal(2, 1) // Nível de dificuldade do conteúdo (0.0 a 5.0)
    createdAt    DateTime @default(now()) @map("created_at")
    updatedAt    DateTime @updatedAt @map("updated_at")

    disciplinaId Int        @map("disciplina_id")
    disciplina   Disciplina @relation(fields: [disciplinaId], references: [id], onDelete: Cascade, onUpdate: Cascade)

    sessoesEstudo SessaoEstudo[]
    revisoes      Revisao[]

    @@unique([titulo, disciplinaId])
    @@index([titulo])
    @@index([concluido])
    @@index([edital])
    @@index([disciplinaId], map: "topico__disciplina_id_fkey")
    @@map("topico")
}

// t = -S x ln(0.9)
// Difícil = 1.15
// Mediano = 1.40
// Fácil = 1.80

model SessaoEstudo {
    id               Int             @id @default(autoincrement())
    dataInicio       DateTime        @default(now()) @map("data_inicio") // Data e hora de início da sessão
    dataTermino      DateTime?       @map("data_termino") // Null enquanto sessão está em andamento
    questoesAcertos  Int             @default(0) @map("questoes_acertos") // Número de questões acertadas
    questoesErros    Int             @default(0) @map("questoes_erros") // Número de questões erradas
    tempoEstudo      Decimal         @default(0.0) @map("tempo_estudo") @db.Decimal(4, 2) // Em horas
    paginasLidas     Int             @default(0) @map("paginas_lidas") // Número de páginas lidas durante a sessão
    topicoFinalizado Boolean         @default(false) @map("topico_finalizado") // Indica se o tópico foi concluído nesta sessão
    observacoes      String?         @db.Text // Anotações adicionais sobre a sessão
    concluida        Boolean         @default(false) // Indica se a sessão foi concluída
    categoriaSessao  CategoriaSessao
    situacaoSessao   SituacaoSessao
    createdAt        DateTime        @default(now()) @map("created_at")
    updatedAt        DateTime        @updatedAt @map("updated_at")

    planoEstudoId Int         @map("plano_estudo_id")
    planoEstudo   PlanoEstudo @relation(fields: [planoEstudoId], references: [id], onDelete: Cascade, onUpdate: Cascade)

    disciplinaId Int        @map("disciplina_id")
    disciplina   Disciplina @relation(fields: [disciplinaId], references: [id], onDelete: Cascade, onUpdate: Cascade)

    topicoId Int    @map("topico_id")
    topico   Topico @relation(fields: [topicoId], references: [id], onDelete: Cascade, onUpdate: Cascade)

    blocoEstudoId Int?
    blocoEstudo   BlocoEstudo? @relation(fields: [blocoEstudoId], references: [id])

    @@index([dataInicio], map: "sessao_estudo__data_inicio_idx")
    @@index([dataTermino], map: "sessao_estudo__data_termino_idx")
    @@index([categoriaSessao], map: "sessao_estudo__categoria_idx")
    @@index([situacaoSessao], map: "sessao_estudo__situacao_idx")
    @@index([topicoFinalizado], map: "sessao_estudo__topico_finalizado_idx")
    @@index([disciplinaId], map: "sessao_estudo__disciplina_id_fkey")
    @@index([planoEstudoId], map: "sessao_estudo__plano_estudo_id_fkey")
    @@index([topicoId], map: "sessao_estudo__topico_id_fkey")
    @@index([blocoEstudoId], map: "sessao_estudo__bloco_estudo_id_fkey")
    @@map("sessao_estudo")
}

model Revisao {
    id              Int             @id @default(autoincrement())
    numero          Int             @db.TinyInt // Número sequencial da revisão (1ª, 2ª, 3ª, etc)
    dataProgramada  DateTime        @map("data_programada") // Data prevista para a revisão
    dataRealizada   DateTime?       @map("data_realizada") // Data em que a revisão foi realizada
    tempoEstudo     Decimal         @default(0.0) @map("tempo_estudo") @db.Decimal(4, 2) // Em horas
    questoesAcertos Int             @default(0) @map("questoes_acertos") // Número de questões acertadas
    questoesErros   Int             @default(0) @map("questoes_erros") // Número de questões erradas
    desempenho      Decimal         @default(0.0) @db.Decimal(3, 1) // Percentual de acerto (0.0 a 100.0)
    concluida       Boolean         @default(false) // Indica se a revisão foi realizada
    situacaoRevisao SituacaoRevisao @map("situacao_revisao")
    createdAt       DateTime        @default(now()) @map("created_at")
    updatedAt       DateTime        @updatedAt @map("updated_at")

    planoEstudoId Int         @map("plano_estudo_id")
    planoEstudo   PlanoEstudo @relation(fields: [planoEstudoId], references: [id], onDelete: Cascade, onUpdate: Cascade)

    disciplinaId Int        @map("disciplina_id")
    disciplina   Disciplina @relation(fields: [disciplinaId], references: [id], onDelete: Cascade, onUpdate: Cascade)

    topicoId Int    @map("topico_id")
    topico   Topico @relation(fields: [topicoId], references: [id], onDelete: Cascade, onUpdate: Cascade)

    @@unique([numero, topicoId]) // Garante numeração sequencial única por tópico
    @@index([dataProgramada], map: "revisao__data_programada_idx")
    @@index([dataRealizada], map: "revisao__data_realizada_idx")
    @@index([planoEstudoId], map: "revisao__plano_estudo_id_fkey")
    @@index([disciplinaId], map: "revisao__disciplina_id_fkey")
    @@index([topicoId], map: "revisao__topico_id_fkey")
    @@map("revisao")
}

model PlanoEstudo {
    id            Int           @id @default(autoincrement())
    titulo        String // Título do plano de estudo
    concurso      String? // Nome do concurso ou exame
    cargo         String? // Cargo ou área de atuação
    banca         String? // Nome da banca examinadora
    dataProva     DateTime?     @map("data_prova") // Data prevista para a prova
    situacao      SituacaoPlano
    domingo_horas Decimal       @default(0.0) @map("domingo_horas") @db.Decimal(4, 2) // Horas de estudo planejadas para domingo
    domingo_ativo Boolean       @default(false) @map("domingo_ativo") // Indica se domingo é um dia ativo de estudo
    segunda_horas Decimal       @default(0.0) @map("segunda_horas") @db.Decimal(4, 2) // Horas de estudo planejadas para segunda-feira
    segunda_ativo Boolean       @default(false) @map("segunda_ativo") // Indica se segunda-feira é um dia ativo de estudo
    terca_horas   Decimal       @default(0.0) @map("terca_horas") @db.Decimal(4, 2) // Horas de estudo planejadas para terça-feira
    terca_ativo   Boolean       @default(false) @map("terca_ativo") // Indica se terça-feira é um dia ativo de estudo
    quarta_horas  Decimal       @default(0.0) @map("quarta_horas") @db.Decimal(4, 2) // Horas de estudo planejadas para quarta-feira
    quarta_ativo  Boolean       @default(false) @map("quarta_ativo") // Indica se quarta-feira é um dia ativo de estudo
    quinta_horas  Decimal       @default(0.0) @map("quinta_horas") @db.Decimal(4, 2) // Horas de estudo planejadas para quinta-feira
    quinta_ativo  Boolean       @default(false) @map("quinta_ativo") // Indica se quinta-feira é um dia ativo de estudo
    sexta_horas   Decimal       @default(0.0) @map("sexta_horas") @db.Decimal(4, 2) // Horas de estudo planejadas para sexta-feira
    sexta_ativo   Boolean       @default(false) @map("sexta_ativo") // Indica se sexta-feira é um dia ativo de estudo
    sabado_horas  Decimal       @default(0.0) @map("sabado_horas") @db.Decimal(4, 2) // Horas de estudo planejadas para sábado
    sabado_ativo  Boolean       @default(false) @map("sabado_ativo") // Indica se sábado é um dia ativo de estudo
    concluido     Boolean       @default(false) @map("concluido") // Indica se o plano de estudo foi concluído
    createdAt     DateTime      @default(now()) @map("created_at")
    updatedAt     DateTime      @updatedAt @map("updated_at")

    usuarioId Int     @map("usuario_id")
    usuario   Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade, onUpdate: Cascade)

    disciplinas   Disciplina[]
    sessoesEstudo SessaoEstudo[]
    revisoes      Revisao[]
    blocosEstudo  BlocoEstudo[]

    @@unique([titulo, usuarioId])
    @@index([titulo], map: "plano_estudo__titulo_idx")
    @@index([concurso], map: "plano_estudo__concurso_idx")
    @@index([banca], map: "plano_estudo__banca_idx")
    @@index([situacao], map: "plano_estudo__situacao_idx")
    @@index([usuarioId], map: "plano_estudo__usuario_id_fkey")
    @@map("plano_estudo")
}

model BlocoEstudo {
    id                   Int      @id @default(autoincrement())
    ordem                Int      @db.TinyInt // Ordem do bloco no dia da semana
    diaSemana            Int      @map("dia_semana") @db.TinyInt // 0=Dom,1=Seg,2=Ter,3=Qua,4=Qui,5=Sex,6=Sáb
    totalHorasPlanejadas Decimal  @map("total_horas_planejadas") @db.Decimal(4, 2) // Duração planejada em horas
    concluido            Boolean  @default(false) @map("concluido") // Indica se o bloco de estudo foi concluído, ou seja, não existem mais horas sobrando para estudar
    createdAt            DateTime @default(now()) @map("created_at")
    updatedAt            DateTime @updatedAt @map("updated_at")

    planoEstudoId Int         @map("plano_estudo_id")
    planoEstudo   PlanoEstudo @relation(fields: [planoEstudoId], references: [id], onDelete: Cascade, onUpdate: Cascade)

    disciplinaId Int        @map("disciplina_id")
    disciplina   Disciplina @relation(fields: [disciplinaId], references: [id], onDelete: Cascade, onUpdate: Cascade)

    sessoesEstudo SessaoEstudo[]

    @@unique([planoEstudoId, diaSemana, ordem])
    @@index([planoEstudoId], map: "bloco_estudo__plano_estudo_id_fkey")
    @@index([disciplinaId], map: "bloco_estudo__disciplina_id_fkey")
    @@index([diaSemana])
    @@map("bloco_estudo")
}
